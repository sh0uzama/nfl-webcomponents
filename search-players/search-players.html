<dom-module id="search-players">

    <style is="custom-style" include="iron-flex iron-flex-alignment" />
    <style>
         :host {
            display: block;
        }

       
    </style>

    <template>

        <paper-dialog id="searchModal" modal on-iron-overlay-closed="_onSearchModalClose">

            <h2>Search Players</h2>

            <div class="search-bar layout horizontal">
                <iron-icon icon="search"></iron-icon>
                <paper-input class="flex" value="{{search}}" on-input="_searchChanged" on-change="_searchChanged" no-label-float="true" label="Player Name" always-float-label></paper-input>
            </div>

            <paper-dialog-scrollable class="search-content">

                <template is="dom-repeat" items="[[_results]]">

                    <paper-item on-tap="_selectItem">
                        <paper-item-body two-line>
                            <div>[[item.Title]]</div>
                            <div secondary>[[item.Slug]]</div>
                        </paper-item-body>
                    </paper-item>

                </template>

            </paper-dialog-scrollable>

            <div class="buttons">
                <paper-button dialog-dismiss raised>Cancel</paper-button>
                <paper-button dialog-confirm raised>Insert</paper-button>
            </div>

        </paper-dialog>


    </template>

    <script>
        var api = ForgeWebComponents.Api;

        function createPlayerSelectedEvent(player) {
            return new CustomEvent('player-selected', { detail: { player: player } });
        }

        Polymer({
            is: "search-players",
            behaviors: [
                ForgeWebComponents.Behaviors.ForgeLocalizeBehavior
            ],
            properties: {
                search: {
                    type: String,
                    notify: true,
                    observer: '_searchChanged'
                }
            },
            _getData: function () {

                var url = "/deltatre.forge.wcm/api/customEntities/players/working?language=nd-nd&stage=published&terms=";

                url = url + encodeURI(this.search);

                var self = this;

                self._hideLoading = false;

                api.raw(url).then(function (result) {
                    self._hideLoading = true;
                    self._results = result;
                }, function () {
                    self._hideLoading = true;
                    self._results = [];
                    console.error(arguments);
                });

            },
            _searchChanged: function () {
                this.debounce('_searchChangedDebouce', this._getData, 500);
            },
            _onSearchModalClose: function (e) {
                if (e.detail.confirmed) {
                    this.dispatchEvent(createPlayerSelectedEvent(this._selectedPlayer));
                }
            },
            _selectItem: function (e) {
                var item = e.model.item;
                this._selectedPlayer = item;
            },
            ready: function () {
                this._selectedPlayer = null;
                this._results = [];
            },
            open: function () {
                this._selectedPlayer = null;
                this.$.searchModal.open();
            }
        });
    </script>

</dom-module>